<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
	<meta name="mobile-web-app-capable" content="yes">

	<link rel='stylesheet' type='text/css' href='css/styles.css'>
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="js/core.js"></script>

	    
  </head>

    <script type="text/javascript">
	    
	var days = [
	    'Söndag',
	    'Måndag',
	    'Tisdag',
	    'Onsdag',
	    'Torsdag',
	    'Fredag',
	    'Lördag'
	];

	var cardinals = [
	    'N',
	    'N',
	    'NNE',
	    'NNO',
	    'NE',
	    'NO',
	    'ENE',
	    'ONO',
	    'E',
	    'Ö',
	    'ESE',
	    'OSO',
	    'SE',
	    'SO',
	    'SSE',
	    'SSO',
	    'S',
	    'S',
	    'SSW',
	    'SSV',
	    'SW',
	    'SV',
	    'WSW',
	    'VSV',
	    'W',
	    'V',
	    'WNW',
	    'VNV',
	    'NW',
	    'NV',
	    'NNW',
	    'NNV'
	];	    
	
	//import Darksky from 'darkskyjs';

	    
	var todayHeaderAdded = false;
	var tomorrowHeaderAdded = false;
	var fridayHeaderAdded = false;
	var saturdayHeaderAdded = false;
	var sundayHeaderAdded = false;
	    	    
	function convertTo24Hour(time) {
	    var hours = parseInt(time.substr(0, 2));
	    if(time.indexOf('am') != -1 && hours == 12) {
			time = time.replace('12', '0');
	    }
	    if(time.indexOf('pm')  != -1 && hours < 12) {
			time = time.replace(hours, (hours + 12));
	    }
	    return time.replace(/(am|pm)/, '');
	}
	
	function getSwe(direction) {
		var i;

		i = $.inArray(direction, cardinals);

		if (i != -1)
			return cardinals[i+1];
		else
			return "ERR";

	}	
	
	var addRow = function (time, desc, loc) {
		var element = document.getElementById('event-list');
		
		if (time != '')
			time = "<span style='color: rgb(120,120,120)'>" + time + "</span> ";
	
		if (loc != '')
			loc =  ", <span style='color: rgb(180,180,180)'>" + loc + "</span>";
	
		element.innerHTML += "<div class='row'>" + time + desc + loc + "</div>";		
	};
      
	function addItem(item) {
		var description;
		var location = '';
		var hm = '';
		var eventDate;
		var nowDate = new Date();
		var tomorrowDate = new Date();

		tomorrowDate.setDate(nowDate.getDate()+1);
		
        // Beskrivning
        description = item.summary;

        // Plats
        if (item.location != undefined)
        	location = item.location;
        else
        	location = '';

        // Start tid i HH:MM eller datum om heldagshändelse
        if (item.start != undefined) {
	        if (item.start.dateTime != undefined) {
		        eventDate = new Date(item.start.dateTime);
				hm = pad(eventDate.getHours(), 2) + ":" + pad(eventDate.getMinutes(), 2);
		    }
		    else {
		    	eventDate = new Date(item.start.date);
		    	hm = '';
		    }
	    }

	    if (nowDate.getDate() == eventDate.getDate()) {
		    // Idag
			if (!todayHeaderAdded) {
				var element = document.getElementById('event-list');
				element.innerHTML += '<div id="today" class="header">Idag</div>';		    	
		    	todayHeaderAdded = true;
			}

			addRow(hm, description, location);

	    }
	    else if (tomorrowDate.getDate() == eventDate.getDate()) {
		    // I morgon

			if (!todayHeaderAdded) {
				var element = document.getElementById('event-list');
				element.innerHTML += '<div id="today" class="header">Idag</div>';
		    	
		    	todayHeaderAdded = true;
				addRow('', 'Zzzzz...', '');
			}

			if (!tomorrowHeaderAdded) {
				var element = document.getElementById('event-list');								
				element.innerHTML += '<div id="tomorrow" class="header">I morgon</div>';
		    	
		    	tomorrowHeaderAdded = true;
			}

			addRow(hm, description, location);

	    }
	    else if (eventDate.getDay() == 5) {
		    // Fredag
			if (!todayHeaderAdded) {
				var element = document.getElementById('event-list');
				element.innerHTML += '<div id="today" class="header">Idag</div>';		    			    	
		    	todayHeaderAdded = true;
				addRow('', 'Zzzzz...', '');
			}

			if (!tomorrowHeaderAdded) {
				var element = document.getElementById('event-list');								
				element.innerHTML += '<div id="tomorrow" class="header">I morgon</div>';		    	
		    	tomorrowHeaderAdded = true;
				addRow('', 'Zzzzz...', '');
			}

			if (!fridayHeaderAdded) {
				var element = document.getElementById('event-list');								
				element.innerHTML += '<div id="tomorrow" class="header">Fredag</div>';		    	
		    	fridayHeaderAdded = true;
			}

			addRow(hm, description, location);

	    }
	    else if (eventDate.getDay() == 6) {
		    // Lördag
			if (!saturdayHeaderAdded) {
				var element = document.getElementById('event-list');								
				element.innerHTML += '<div id="tomorrow" class="header weekend">Lördag</div>';
		    	saturdayHeaderAdded = true;
			}

			addRow(hm, description, location);

	    }
	    else if (eventDate.getDay() == 0) {
		    // Söndag
			if (!sundayHeaderAdded) {
				var element = document.getElementById('event-list');								
				element.innerHTML += '<div id="tomorrow" class="header weekend">Söndag</div>';		    	
		    	sundayHeaderAdded = true;
			}

			addRow(hm, description, location);

	    }		
	}    
	
	function drawWeather() {
		var nowDate = new Date();
		/*

		darkSky.getCurrentConditions(
		  [
		    {
		      latitude: 55.7099803,
		      longitude: 13.3686299,
		      name: 'Sandby'
		    }
		  ],
		  function(conditions) {
		    for (var i = 0, length = conditions.length; i < length; i++) {
		      if (conditions[i].name === 'Sandby') {
		        console.log(conditions[i].cloudCover());
		      }
		    }
		  }
		  );		 
		   
		$.simplerWeather({
			authmethod: 'proxy',
			proxyurl: 'http://app-o.se/jbn/kalender/js/proxy.php',
		    success: function(weather) {
console.log("w:", weather);
		      html = '<br/><br/><br/><div class="container"><i class="icon-' + weather.code + '"></i><div class="UR pushdown">' + weather.alt.temp + '<small>&deg; ('+ Math.round(weather.wind.speed * 0.44704) + ' m/s ' + getSwe(weather.wind.direction).toLowerCase() + ')</small></div>';
			  html = html + '<div class="LR">Idag</div><br/></div>';

		      html = html + '<div class="container"><i class="icon-' + weather.forecast[1].code + ' lighter"></i><div class="UR lighter"><strong class="lighter">[</strong> ' + weather.forecast[1].alt.high + '&deg; <strong class="lighter">]</strong> ' + weather.forecast[1].alt.low + '&deg;</div>';
			  html = html + '<div class="LR" style="color:rgb(200, 200, 200);">' + days[(nowDate.getDay()+1) % 7] + '</div></div>';
		      html = html + '<div class="container"><i class="icon-' + weather.forecast[2].code + ' evenLighter"></i><div class="UR evenLighter"><strong class="evenLighter">[</strong> ' + weather.forecast[2].alt.high + '&deg; <strong class="evenLighter">]</strong> ' + weather.forecast[2].alt.low + '&deg;</div>';
			  html = html + '<div class="LR" style="color:rgb(220, 220, 220);">' + days[(nowDate.getDay()+2) % 7] + '</div></div>';

		      $("#weather").html(html);

		      $("#sunrise").html('<strong>7</strong>' + convertTo24Hour(weather.sunrise));
			  $("#sunset").html('<strong>8</strong>' + convertTo24Hour(weather.sunset));

		    },

		    error: function(error) {
				console.log("err:", error);
		      $("#weather").html('<p>'+error+'</p>');
		    }

		});*/
	}

	function printCalendar() {
		var calendarId = 'f7adpar1ncg3bhf3up3nkc71q4dbo519@import.calendar.google.com';
		var apiKey = 'AIzaSyCAKoToklkt870xc8CjPx2wp9k8lfzi_ns';		
		var d = new Date();
		var aWeekForwardDate = new Date(d.getFullYear(), d.getMonth(), d.getDate()+7);			
		var e;		
			
		todayHeaderAdded = false;
		tomorrowHeaderAdded = false;
		fridayHeaderAdded = false;
		saturdayHeaderAdded = false;
		sundayHeaderAdded = false;
		
		e = document.getElementById('event-list');								
		e.innerHTML = '';		    	

		var e = document.getElementById('timestamp');							
		e.innerHTML = d.toLocaleTimeString() + ", v. " + d.getWeek();		    	

		var e = document.getElementById('background');							
		e.innerHTML = d.getDate();		    			
	
		gapi.client.init({
			'apiKey': apiKey,
			'discoveryDocs': ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
		}).then(function () {
			return gapi.client.calendar.events.list({
				'calendarId': calendarId,
				'singleEvents': true,
				'timeMin': (new Date()).toISOString(),
				'timeMax': aWeekForwardDate.toISOString(),
				'orderBy': 'startTime'
			});
		}).then(function (response) {
			if (response.result.items) {
				response.result.items.forEach(function(item) {
					addItem(item);
				});
			}
		}, function (reason) {
			console.log('Error: ' + reason.result.error.message);
		});
		
	  	setTimeout(printCalendar, 5*60*1000);
	  	
	  	//drawWeather();
		
	}

	gapi.load('client', printCalendar);

    </script>

	<body>
    
	<div class="frame">
		<div id='event-list' class="event-list"></div>
		<div id="weather"></div>
		<div id="background">Dagens datum</div>
	</div>
	<div id="timestamp" class="timestamp">timestamp</div>
	<div id="sunrise" class="sunrise">sunrise</div>
	<div id="sunset" class="sunset">sunset</div>    

    
	</body>
	
</html>